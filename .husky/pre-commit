#!/usr/bin/env sh
# START: Husky Pre-Commit Hook - Smart Linting and Compilation
# This hook runs before each commit to ensure code quality
echo "ğŸ” Running pre-commit checks..."

# Detect which workspace has staged changes
BACKEND_STAGED=$(git diff --cached --name-only | grep -E '^nsc-events-nestjs/.*\.(ts|js)$' || echo "")
FRONTEND_STAGED=$(git diff --cached --name-only | grep -E '^nsc-events-nextjs/.*\.(ts|tsx|js|jsx)$' || echo "")

# If no code files staged, skip checks
if [ -z "$BACKEND_STAGED" ] && [ -z "$FRONTEND_STAGED" ]; then
  echo "âœ… No code changes staged - skipping checks"
  exit 0
fi

# Run lint-staged for efficient linting (already workspace-aware)
echo "ğŸ“ Linting staged files..."
npm run lint:staged

if [ $? -ne 0 ]; then
  echo "âŒ Linting failed! Commit blocked."
  echo "Fix linting issues or bypass with: git commit --no-verify"
  exit 1
fi

# Compile only affected workspaces
if [ -n "$BACKEND_STAGED" ]; then
  echo "ğŸ”¨ Compiling backend TypeScript..."
  npm run compile --workspace=nsc-events-nestjs
  if [ $? -ne 0 ]; then
    echo "âŒ Backend compilation failed! Commit blocked."
    exit 1
  fi
  echo "âœ… Backend compilation passed"
fi

if [ -n "$FRONTEND_STAGED" ]; then
  echo "ğŸ”¨ Compiling frontend TypeScript..."
  npm run compile --workspace=nsc-events-nextjs
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend compilation failed! Commit blocked."
    exit 1
  fi
  echo "âœ… Frontend compilation passed"
fi

echo "ğŸ‰ All pre-commit checks passed!"
# END: Husky Pre-Commit Hook
