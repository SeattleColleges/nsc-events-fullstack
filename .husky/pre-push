#!/usr/bin/env sh
# START: Husky Pre-Push Hook - Smart CI Pipeline Simulation
# This hook mirrors the GitHub workflow: only tests changed workspaces
echo "üöÄ Running pre-push checks..."
echo "üìã Detecting changed files (mirroring GitHub workflow)..."
echo "Branch: $(git branch --show-current)"
echo ""

# Detect changes in backend and frontend (excluding docs/config)
BACKEND_CHANGED=$(git diff --name-only HEAD @{u} 2>/dev/null | grep -E '^nsc-events-nestjs/' | grep -Ev '\.(md|gitignore|prettierrc|eslintrc\.js)$|LICENSE' || echo "")
FRONTEND_CHANGED=$(git diff --name-only HEAD @{u} 2>/dev/null | grep -E '^nsc-events-nextjs/' | grep -Ev '\.(md|gitignore|prettierrc|eslintrc\.js)$|LICENSE' || echo "")

# If no upstream, check against origin/main
if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
  BACKEND_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null | grep -E '^nsc-events-nestjs/' | grep -Ev '\.(md|gitignore|prettierrc|eslintrc\.js)$|LICENSE' || echo "")
  FRONTEND_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null | grep -E '^nsc-events-nextjs/' | grep -Ev '\.(md|gitignore|prettierrc|eslintrc\.js)$|LICENSE' || echo "")
fi

# Check if only docs/config changed
if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
  echo "‚úÖ Only documentation or config files changed - skipping all checks"
  echo "Proceeding with push..."
  exit 0
fi

# Backend CI Pipeline
if [ -n "$BACKEND_CHANGED" ]; then
  echo "üì¶ Backend changes detected - running backend checks..."
  echo ""
  
  echo "  ‚ñ∂ Linting backend..."
  npm run lint:backend
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend linting failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Compiling backend TypeScript..."
  npm run compile --workspace=nsc-events-nestjs
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend compilation failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Running backend tests..."
  npm run test:backend
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend tests failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Building backend..."
  npm run build:backend
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend build failed! Push blocked."
    exit 1
  fi
  
  echo "‚úÖ Backend checks passed!"
  echo ""
else
  echo "‚è≠Ô∏è  No backend changes - skipping backend checks"
  echo ""
fi

# Frontend CI Pipeline
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "üé® Frontend changes detected - running frontend checks..."
  echo ""
  
  echo "  ‚ñ∂ Linting frontend..."
  npm run lint:frontend
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend linting failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Compiling frontend TypeScript..."
  npm run compile --workspace=nsc-events-nextjs
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend compilation failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Running frontend tests..."
  npm run test:frontend
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend tests failed! Push blocked."
    exit 1
  fi
  
  echo "  ‚ñ∂ Building frontend..."
  npm run build:frontend
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend build failed! Push blocked."
    exit 1
  fi
  
  echo "‚úÖ Frontend checks passed!"
  echo ""
else
  echo "‚è≠Ô∏è  No frontend changes - skipping frontend checks"
  echo ""
fi

echo "üéâ All pre-push checks passed!"
echo "Your code mirrors the GitHub CI workflow!"
echo "Proceeding with push..."
echo ""
# END: Husky Pre-Push Hook